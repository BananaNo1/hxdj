<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leis.hxds.odr.db.dao.OrderDao">
    <select id="searchDriverTodayBusinessData" parameterType="long" resultType="HashMap">
        select sum(timestampdiff(hour,end_time, start_time)) as duration,
               sum(real_free)                                as income,
               count(id)                                     as orders
        from tb_order
        where driver_id = #{driverId}
          and `status` in (5, 6, 7, 8)
          and date = current_date
    </select>

    <insert id="insert" parameterType="com.leis.hxds.odr.db.pojo.OrderEntity">
        insert into tb_order
        set uuid = #{uuid}, customer_id = #{customerId}, start_place = #{startPlace}, start_place_location = #{startPlaceLocation}, end_place = #{endPlace}, end_place_location = #{endPlaceLoaction}, expects_mileage = #{expectsMileage}, expects_fee= #{expectsFee}, favour_fee = #{favourFee}, charge_rule_id = #{chargeRuleId}, car_place = #{carPlace}, car_type = #{carType}, date = #{date}
    </insert>

    <select id="searchOrderIdByUUID" parameterType="String" resultType="String">
        select cast(id as char) as id
        from tb_order
        where uuid = #{uuid}
    </select>

    <update id="acceptNewOrder" parameterType="Map">
        update tb_order
        set driver_id   = #{driverId},
            accept_time = now(),
            `status=2`
        where id = #{orderId}
    </update>

    <select id="searchDriverExecutorOrder" parameterType="Map" resultType="HashMap">
        select cast(id as char)                              as id,
               customer_id                                   as customerId,
               start_place                                   as startPlace,
               start_place_location                          as startPlaceLocation,
               end_place                                     as endPlace,
               end_place_location                            as endPlaceLocation,
               cast(favour_fee as char)                      as favourFee,
               car_plate                                     as carPlate,
               car_type                                      as carType,
               DATE_FORMAT(create_time, '%Y-%m-%d %H:%i:%s') as createTime
        from tb_order
        where id = #{orderId}
          and driver_id = #{driverId}
    </select>

    <select id="searchOrderStatus" parameterType="Map" resultType="Integer">
        select status
        from tb_order
        where id =#{orderId}
        <if test="driverId!=null">
            and driver_id = #{driverId}
        </if>
        <if test="customerId!=null">
            and customer_id = #{customerId}
        </if>
    </select>

    <delete id="deleteAcceptOrder" parameterType="Map">
        delete from tb_order
        where id =#{orderId}
        <if test="driverId!=null">
            and driver_id = #{driverId}
        </if>
        <if test="customerId!=null">
            and customer_id =#{customerId}
        </if>
    </delete>

    <select id="searchDriverCurrentOrder" parameterType="long" resultType="HashMap">
        select cast(id as char)                              as id,
               customer_id                                   as customerId,
               start_place                                   as startPlace,
               start_place_location                          as startPlaceLocation,
               end_place                                     as endPlace,
               end_place_location                            as endPlaceLocation,
               cast(favour_fee as char)                      as favourFee,
               car_plate                                     as carPlate,
               car_type                                      as carType,
               DATE_FORMAT(create_time, '%Y-%m-%d %H:%i:%s') as createTime,
               `status`
        from tb_order
        where driver_id = #{driverId}
          and `status` in (2, 3, 4) limit 1
    </select>

    <select id="hashCustomerUnFinishedOrder" parameterType="long" resultType="long">
        select cast(id as char) as id
        from tb_order
        where customer_id = #{customerId}
          and `status` in (2, 3, 4) limit 1;
    </select>

    <select id="hashCustomerUnAcceptOrder" parameterType="long" resultType="HashMap">
        select cast(id as char)     as id,
               start_place          as startPlace,
               start_place_location as startPlaceLocation,
               end_place            as endPlace,
               end_place_location   as endPlaceLocation,
               car_plate            as carPlate,
               car_type             as carType
        from tb_order
        where customer_id = #{customerId}
          and `status` = 1 limit 1;
    </select>
</mapper>
