<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leis.hxds.odr.db.dao.OrderDao">
    <select id="searchDriverTodayBusinessData" parameterType="long" resultType="HashMap">
        select sum(timestampdiff(hour,end_time, start_time)) as duration,
               sum(real_free)                                as income,
               count(id)                                     as orders
        from tb_order
        where driver_id = #{driverId}
          and `status` in (5, 6, 7, 8)
          and date = current_date
    </select>

    <insert id="insert" parameterType="com.leis.hxds.odr.db.pojo.OrderEntity">
        insert into tb_order
        set uuid = #{uuid}, customer_id = #{customerId}, start_place = #{startPlace}, start_place_location = #{startPlaceLocation}, end_place = #{endPlace}, end_place_location = #{endPlaceLoaction}, expects_mileage = #{expectsMileage}, expects_fee= #{expectsFee}, favour_fee = #{favourFee}, charge_rule_id = #{chargeRuleId}, car_place = #{carPlace}, car_type = #{carType}, date = #{date}
    </insert>

    <select id="searchOrderIdByUUID" parameterType="String" resultType="String">
        select cast(id as char) as id
        from tb_order
        where uuid = #{uuid}
    </select>

    <update id="acceptNewOrder" parameterType="Map">
        update tb_order
        set driver_id   = #{driverId},
            accept_time = now(),
            `status=2`
        where id = #{orderId}
    </update>

    <select id="searchDriverExecutorOrder" parameterType="Map" resultType="HashMap">
        select cast(id as char)                              as id,
               customer_id                                   as customerId,
               start_place                                   as startPlace,
               start_place_location                          as startPlaceLocation,
               end_place                                     as endPlace,
               end_place_location                            as endPlaceLocation,
               cast(favour_fee as char)                      as favourFee,
               car_plate                                     as carPlate,
               car_type                                      as carType,
               DATE_FORMAT(create_time, '%Y-%m-%d %H:%i:%s') as createTime
        from tb_order
        where id = #{orderId}
          and driver_id = #{driverId}
    </select>

    <select id="searchOrderStatus" parameterType="Map" resultType="Integer">
        select status
        from tb_order
        where id =#{orderId}
        <if test="driverId!=null">
            and driver_id = #{driverId}
        </if>
        <if test="customerId!=null">
            and customer_id = #{customerId}
        </if>
    </select>

    <delete id="deleteAcceptOrder" parameterType="Map">
        delete from tb_order
        where id =#{orderId}
        <if test="driverId!=null">
            and driver_id = #{driverId}
        </if>
        <if test="customerId!=null">
            and customer_id =#{customerId}
        </if>
    </delete>

    <select id="searchDriverCurrentOrder" parameterType="long" resultType="HashMap">
        select cast(id as char)                              as id,
               customer_id                                   as customerId,
               start_place                                   as startPlace,
               start_place_location                          as startPlaceLocation,
               end_place                                     as endPlace,
               end_place_location                            as endPlaceLocation,
               cast(favour_fee as char)                      as favourFee,
               car_plate                                     as carPlate,
               car_type                                      as carType,
               DATE_FORMAT(create_time, '%Y-%m-%d %H:%i:%s') as createTime,
               `status`
        from tb_order
        where driver_id = #{driverId}
          and `status` in (2, 3, 4) limit 1
    </select>

    <select id="hashCustomerUnFinishedOrder" parameterType="long" resultType="long">
        select cast(id as char) as id
        from tb_order
        where customer_id = #{customerId}
          and `status` in (2, 3, 4) limit 1;
    </select>

    <select id="hashCustomerUnAcceptOrder" parameterType="long" resultType="HashMap">
        select cast(id as char)     as id,
               start_place          as startPlace,
               start_place_location as startPlaceLocation,
               end_place            as endPlace,
               end_place_location   as endPlaceLocation,
               car_plate            as carPlate,
               car_type             as carType
        from tb_order
        where customer_id = #{customerId}
          and `status` = 1 limit 1;
    </select>

    <select id="searchOrderForMoveById" parameterType="map" resultType="HashMap">
        select
        start_place as startPlace,
        start_place_location as startPlaceLocation,
        end_place as endPlace,
        end_place_location as endPlaceLocation,
        `status`
        from tb_order
        where id=#{orderId}
        <if test="customerId!=null">
            and customer_id = #{customerId}
        </if>
        <if test="driverId!=null">
            and driver_id = #{driverId}
        </if>
        limit 1;
    </select>

    <update id="updateOrderStatus" parameterType="Map">
        update tb_order
        set
        <if test="status==3">
            arrive_time = now(),
        </if>
        <if test="status==4">
            start_time = now(),
            waiting_minute = TIMESTAMPDIFF(MINUTE,arrive_time,now()),
        </if>
        <if test="status==5">
            end_time = now(),
        </if>
        `status` = #{status}
        where id =#{orderId}
        <if test="customerId!=null">
            and customer_id = #{customerId}
        </if>
        <if test="driverId!=null">
            and driver_id =#{driverId}
        </if>
    </update>

    <select id="searchOrderByPage" parameterType="Map" resultType="HashMap">
        select cast(id as char) as id,
        cast(start_place as char) as startPlace,
        cast(end_place as char) as endPlace,
        cast(real_mileage as char) as realMileage,
        cast(real_fee as char) as realFee,
        `status`,
        DATE_FORMAT(create_time,'%Y-%m-%d %H:%i') as createTime
        from tb_order
        where 1=1
        <if test="orderId!=null">
            and id =#{orderId}
        </if>
        <if test="customerId!=null">
            and customer_id =#{customerId}
        </if>
        <if test="driverId!=null">
            and driver_id =#{driverId}
        </if>
        <if test="startDate!=null and endDate!=null">
            and date between #{startDate} and #{endDate}
        </if>
        <if test="status!=null">
            and `status` =#{status}
        </if>
        order by id desc
        limit #{start},#{length}
    </select>

    <select id="searchOrderCount" parameterType="Map" resultType="long">
        select count(*)
        from tb_order
        where 1=1
        <if test="orderId!=null">
            and id =#{orderId}
        </if>
        <if test="customerId!=null">
            and customer_id =#{customerId}
        </if>
        <if test="driverId!=null">
            and driver_id =#{driverId}
        </if>
        <if test="startDate!=null and endDate!=null">
            and date between #{startDate} and #{endDate}
        </if>
        <if test="status!=null">
            and `status` =#{status}
        </if>
    </select>

    <select id="searchOrderContent" parameterType="long" resultType="HashMap">
        select cast(o.driver_id as char)                      as driverId,
               cast(o.customer_id as char)                    as customerId,
               o.car_plate                                    as carPlate,
               o.car_type                                     as carType,
               DATE_FORMAT(o.accept_time, '%Y-%m-%d %H:%i')   as acceptTime,
               DATE_FORMAT(o.arrive_time, '%Y-%m-%d %H:%i')   as arriveTime,
               DATE_FORMAT(o.start_time, '%Y-%m-%d %H:%i')    as startTime,
               DATE_FORMAT(o.end_time, '%Y-%m-%d %H:%i')      as endTime,
               o.waiting_minute                               as waitingMinute,
               TIMESTAMPDIFF(minute,o.start_time, o.end_time) as `driverMinute`,
               cast(o.real_mileage as char)                   as realMileage,
               cast(o.real_fee as char)                       as realFee,
               o.`status`,
               cast(o.charge_rule_id as char)                 as chargeRuleId,
               cast(o.cacel_rule_id as char)                  as canelRuleId,
               cast(p.rule_id as char)                        as profitsharingRuleId,
               o.start_place_location                         as startPlaceLocation,
               o.end_place_location                           as endPlaceLocation
        from tb_order o
                 left join tb_order_profitsharing p on o.id = p.order_id
        where o.id = #{orderId}
    </select>
</mapper>
