<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.leis.hxds.vhr.db.dao.VoucherDao">
    <insert id="insert" parameterType="com.leis.hxds.vhr.db.pojo.VoucherEntity">
        INSERT INTO tb_voucher
        SET uuid = #{uuid},
        name = #{name},
        remark = #{remark},
        tag = #{tag},
        total_quota = #{totalQuota},
        take_count = #{takeCount},
        used_count = #{usedCount},
        discount = #{discount},
        with_amount = #{withAmount},
        type = #{type},
        limit_quota = #{limitQuota},
        <if test="timeType!=null">
            time_type = #{timeType},
        </if>
        <if test="days!=null">
            days = #{days},
        </if>
        <if test="startTime!=null">
            start_time = #{startTime},
        </if>
        <if test="endTime!=null">
            end_time = #{endTime},
        </if>
        `status` = #{status}
    </insert>

    <select id="searchIdByUUID" parameterType="list" resultType="String">
        SELECT CAST(id AS CHAR) AS id
        FROM tb_voucher
        WHERE uuid IN
        <foreach collection="list" separator="," item="one" open="(" close=")">
            #{one}
        </foreach>
    </select>

    <select id="searchVoucherByPage" parameterType="Map" resultType="HashMap">
        select cast(id as char) as id,
        uuid,
        `name`,
        remark,
        tag,
        total_quota as totalQuota,
        take_count as takeCount,
        used_count as usedCount,
        cast(discount as char) as discount,
        cast(with_amount as char) as withAmount,
        type,
        limit_quota as limitQuota,
        `status`,
        time_type as timeType,
        days,
        DATE_FORMAT(start_time, '%Y-%m-%d') as startTime,
        DATE_FORMAT(end_time, '%Y-%m-%d') as endTime,
        DATE_FORMAT(create_time, '%Y-%m-%d') as createTime,
        from tb_voucher
        where 1=1
        <if test="name!=null">
            and `name` like '%${name}%'
        </if>
        <if test="tag!=null">
            and tag like '%${tag}%'
        </if>
        <choose>
            <when test="totalQuota=='无限量'">
                and total_quota = 0
            </when>
            <when test="totalQuota=='有限量'">
                and total_quota > 0
            </when>
        </choose>
        <if test="type!=null">
            and type=#{type}
        </if>
        <choose>
            <when test="limitQuota=='有限制'">
                and limit_quota = 1
            </when>
            <when test="limitQuota=='无限制'">
                and limit_quota=0
            </when>
        </choose>
        <if test="status!=null">
            and `status`=#{status}
        </if>
        <choose>
            <when test="timeType=='有效天数'">
                and time_type=1
            </when>
            <when test="timeType=='有效日期'">
                and time_type=2
            </when>
            <when test="timeType=='无期限'">
                and time_type is null
            </when>
        </choose>
        order by id desc
        limit #{start},#{length}
    </select>

    <select id="searchVoucherCount" parameterType="Map" resultType="long">
        select count(*)
        from tb_voucher
        where 1=1
        <if test="name!=null">
            and `name` like '%${name}%'
        </if>
        <if test="tag!=null">
            and tag like '%${tag}%'
        </if>
        <choose>
            <when test="totalQuota=='无限量'">
                and total_quota = 0
            </when>
            <when test="totalQuota=='有限量'">
                and total_quota > 0
            </when>
        </choose>
        <if test="type!=null">
            and type=#{type}
        </if>
        <choose>
            <when test="limitQuota=='有限制'">
                and limit_quota = 1
            </when>
            <when test="limitQuota=='无限制'">
                and limit_quota=0
            </when>
        </choose>
        <if test="status!=null">
            and `status`=#{status}
        </if>
        <choose>
            <when test="timeType=='有效天数'">
                and time_type=1
            </when>
            <when test="timeType=='有效日期'">
                and time_type=2
            </when>
            <when test="timeType=='无期限'">
                and time_type is null
            </when>
        </choose>
    </select>

    <select id="searchVoucherById" parameterType="long" resultType="HashMap">
        select uuid,
               `name`,
               remark,
               tag,
               total_quota                         as totalQuota,
               take_count                          as takeCount,
               used_count                          as usedCount,
               discount,
               with_amount                         as withAmount,
               `type`,
               limit_quota                         as limitQuota,
               time_type                           as timeType,
               days,
               DATE_FORMAT(start_time, '%Y-%m-%d') as startTime,
               DATE_FORMAT(end_time, '%Y-%m-%d')   as endTime,
               `status`
        from tb_voucher
        where id = #{id}
    </select>

    <update id="updateVoucherStatus" parameterType="Map">
        update tb_voucher
        set `status`=#{status}
        where id = #{id}
    </update>

    <select id="searchVoucherTakeCount" resultType="HashMap">
        select id,uuid,total_quota as totalQuota, take_count as takeCount
        from tb_voucher
        where id in
        <foreach collection="array" open="(" separator="," close=")" item="one">
            #{one}
        </foreach>
    </select>

    <delete id="deleteVoucherByIds">
        delete from tb_voucher
        where id in
        <foreach collection="array" open="(" separator="," close=")" item="one">
            #{one}
        </foreach>
    </delete>
</mapper>
